name: Battery Butler CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

env:
  ORG_GRADLE_PROJECT_PRODUCTION_SERVER_URL: ${{ secrets.PRODUCTION_SERVER_URL }}

jobs:
  # Detect if this is a documentation-only change to skip expensive builds
  changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
      needs_spotless: ${{ steps.filter.outputs.needs_spotless }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.kt'
              - '**/*.java'
              - '**/*.swift'
              - '**/*.gradle.kts'
              - 'gradle/**'
              - 'gradlew*'
              - '**/build.gradle.kts'
              - 'settings.gradle.kts'
              - '**/*.proto'
              - 'compose-app/**'
              - 'domain/**'
              - 'usecase/**'
              - 'data/**'
              - 'data-local/**'
              - 'data-network/**'
              - 'presentation-*/**'
              - 'viewmodel/**'
              - 'fixtures/**'
              - 'ai/**'
              - 'server/**'
              - 'ios-app-*/**'
              - 'android-screenshot-tests/**'
              - 'scripts/**'
              - '.github/workflows/**'
              - '.github/actions/**'
            docs_only:
              - '**/*.md'
              - '.beads/**'
              - '.agent/**'
              - 'CLAUDE.md'
              - 'LICENSE'
              - '.gitignore'
              - '.gitattributes'
            # Files that need spotless (code + markdown)
            needs_spotless:
              - '**/*.kt'
              - '**/*.java'
              - '**/*.md'
              - '**/*.gradle.kts'

  validation_spotless:
    needs: changes
    if: needs.changes.outputs.needs_spotless == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Clean Project
        run: echo "Skipping clean to use cache (if available) and speed up build"
      - name: Check Formatting (Spotless)
        run: ./gradlew spotlessCheck --stacktrace

  validation_lint:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Run Lint
        run: ./gradlew lint --stacktrace

  validation_test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Run Unit Tests
        run: ./gradlew test --stacktrace

  validation_instrumented:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Run Instrumented Tests
        run: ./scripts/test.sh

  validation_architecture:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Run Architecture Analysis
        run: ./scripts/analyze-architecture.sh

  build_android:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Android App
        run: ./gradlew :compose-app:assembleDebug
      - name: Upload Android APKs and AABs
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-android-builds
          path: |
            compose-app/build/outputs/**/*.apk
            compose-app/build/outputs/**/*.aab
          retention-days: 90

  build_ios_compose:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout
        uses: actions/checkout@v4

      # Gradle caching for KMP framework build
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-ios-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-ios-
            ${{ runner.os }}-gradle-

      - name: Cache Xcode DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-compose-${{ hashFiles('ios-app-compose-ui/**/*.swift', 'ios-app-compose-ui/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-xcode-compose-

      - name: Build iOS App (Compose UI)
        run: |
          xcodebuild -project ios-app-compose-ui/iosAppComposeUI.xcodeproj -configuration Debug -scheme iosAppComposeUI -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO CONFIGURATION_BUILD_DIR=build/ios-compose/

      - name: Upload iOS App (Compose UI)
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-ios-compose-app
          path: ios-app-compose-ui/build/
          retention-days: 90

  build_ios_native:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout
        uses: actions/checkout@v4

      # Gradle caching for KMP framework build
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-ios-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-ios-
            ${{ runner.os }}-gradle-

      # Bazel caching for proto generation
      - name: Cache Bazel
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: ${{ runner.os }}-bazel-${{ hashFiles('WORKSPACE', 'MODULE.bazel', 'protos/**') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: Cache Xcode DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-native-${{ hashFiles('ios-app-swift-ui/**/*.swift', 'ios-app-swift-ui/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-xcode-native-

      - name: Build iOS App (SwiftUI)
        run: |
          cd ios-app-swift-ui
          xcodebuild -project iosAppSwiftUI.xcodeproj -configuration Debug -scheme iosAppSwiftUI -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO CONFIGURATION_BUILD_DIR=build/

      - name: Upload iOS App (SwiftUI)
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-ios-swiftui-app
          path: ios-app-swift-ui/build/
          retention-days: 90

  build_desktop:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Desktop App
        run: ./gradlew :compose-app:packageDistributionForCurrentOS
      - name: Upload Desktop Binaries
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-desktop-dist-${{ matrix.os }}
          path: compose-app/build/compose/binaries
          retention-days: 90
          compression-level: 0

  build_server:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Server
        run: ./gradlew :server:app:build
      - name: Upload Server JAR
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-server-jar
          path: server/app/build/libs/
          retention-days: 90

  # Single required status check that works with path filtering
  # This job passes if all required jobs passed OR were skipped (docs-only changes)
  ci:
    needs:
      - changes
      - validation_spotless
      - validation_lint
      - validation_test
      - validation_instrumented
      - validation_architecture
      - build_android
      - build_ios_compose
      - build_ios_native
      - build_desktop
      - build_server
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check CI Status
        run: |
          # Check if any job failed (skipped jobs are OK)
          if [[ "${{ needs.validation_spotless.result }}" == "failure" ]] || \
             [[ "${{ needs.validation_lint.result }}" == "failure" ]] || \
             [[ "${{ needs.validation_test.result }}" == "failure" ]] || \
             [[ "${{ needs.validation_instrumented.result }}" == "failure" ]] || \
             [[ "${{ needs.validation_architecture.result }}" == "failure" ]] || \
             [[ "${{ needs.build_android.result }}" == "failure" ]] || \
             [[ "${{ needs.build_ios_compose.result }}" == "failure" ]] || \
             [[ "${{ needs.build_ios_native.result }}" == "failure" ]] || \
             [[ "${{ needs.build_desktop.result }}" == "failure" ]] || \
             [[ "${{ needs.build_server.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed or were skipped (docs-only change)"
