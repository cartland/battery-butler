name: Battery Butler CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

env:
  ORG_GRADLE_PROJECT_PRODUCTION_SERVER_URL: ${{ secrets.PRODUCTION_SERVER_URL }}

jobs:
  # Detect which files changed to skip unnecessary CI jobs
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      kotlin-changed: ${{ steps.filter.outputs.kotlin }}
      swift-changed: ${{ steps.filter.outputs.swift }}
      gradle-changed: ${{ steps.filter.outputs.gradle }}
      server-changed: ${{ steps.filter.outputs.server }}
      ios-compose-changed: ${{ steps.filter.outputs.ios-compose }}
      ios-native-changed: ${{ steps.filter.outputs.ios-native }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            kotlin:
              - '**/*.kt'
              - '**/*.kts'
              - 'gradle/**'
              - 'gradlew*'
            swift:
              - '**/*.swift'
              - 'ios-app-swift-ui/**'
            gradle:
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle.properties'
              - 'buildSrc/**'
              - 'gradle/**'
            server:
              - 'server/**'
            ios-compose:
              - 'ios-app-compose-ui/**'
              - '**/*.kt'
            ios-native:
              - 'ios-app-swift-ui/**'
              - '**/*.swift'

  validation_spotless:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Clean Project
        run: echo "Skipping clean to use cache (if available) and speed up build"
      - name: Check Formatting (Spotless)
        run: ./gradlew spotlessCheck --stacktrace

  validation_lint:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Run Lint
        run: ./gradlew lint --stacktrace

  validation_test:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Run Unit Tests
        run: ./gradlew test --stacktrace

  validation_instrumented:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Run Instrumented Tests
        run: ./scripts/test.sh

  build_android:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Android App
        run: ./gradlew :compose-app:assembleDebug
      - name: Upload Android APKs and AABs
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-android-builds
          path: |
            compose-app/build/outputs/**/*.apk
            compose-app/build/outputs/**/*.aab
          retention-days: 90

  build_ios_compose:
    needs: detect-changes
    if: needs.detect-changes.outputs.ios-compose-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build iOS App (Compose UI)
        run: |
          xcodebuild -project ios-app-compose-ui/iosAppComposeUI.xcodeproj -configuration Debug -scheme iosAppComposeUI -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO CONFIGURATION_BUILD_DIR=build/ios-compose/

      - name: Upload iOS App (Compose UI)
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-ios-compose-app
          path: ios-app-compose-ui/build/
          retention-days: 90

  build_ios_native:
    needs: detect-changes
    if: needs.detect-changes.outputs.ios-native-changed == 'true'
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build iOS App (SwiftUI)
        run: |
          cd ios-app-swift-ui
          xcodebuild -project iosAppSwiftUI.xcodeproj -configuration Debug -scheme iosAppSwiftUI -destination 'generic/platform=iOS Simulator' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO CONFIGURATION_BUILD_DIR=build/

      - name: Upload iOS App (SwiftUI)
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-ios-swiftui-app
          path: ios-app-swift-ui/build/
          retention-days: 90

  build_desktop:
    needs: detect-changes
    if: needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Desktop App
        run: ./gradlew :compose-app:packageDistributionForCurrentOS
      - name: Upload Desktop Binaries
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-desktop-dist-${{ matrix.os }}
          path: compose-app/build/compose/binaries
          retention-days: 90
          compression-level: 0

  build_server:
    needs: detect-changes
    if: needs.detect-changes.outputs.server-changed == 'true' || needs.detect-changes.outputs.kotlin-changed == 'true' || needs.detect-changes.outputs.gradle-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-java-gradle
      - name: Build Server
        run: ./gradlew :server:app:build
      - name: Upload Server JAR
        uses: actions/upload-artifact@v4
        with:
          name: battery-butler-server-jar
          path: server/app/build/libs/
          retention-days: 90
