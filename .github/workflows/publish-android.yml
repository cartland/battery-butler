name: Publish Android to Play Store

on:
  workflow_dispatch:
    inputs:
      version_code:
        description: 'Version code (integer)'
        required: true
        type: string
  push:
    tags:
      - 'android/[0-9]*'

# Safety limit to prevent accidentally exhausting version codes.
# Change this value if you need higher version codes.
# Google Play hard limit is 2,100,000,000.
env:
  VERSION_CODE_SAFETY_LIMIT: 1000000

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Determine version code
        id: validate
        run: |
          # Get version from tag or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version_code }}"
            echo "Source: manual workflow dispatch"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#android/}"
            echo "Source: tag $TAG"
          fi

          # Check if VERSION is a valid integer
          if ! [[ "$VERSION" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid version code. Expected an integer, got: $VERSION"
            exit 1
          fi

          # Check minimum
          if [ "$VERSION" -lt 1 ]; then
            echo "::error::versionCode must be at least 1, got: $VERSION"
            exit 1
          fi

          # Check against safety limit (configurable at top of workflow)
          if [ "$VERSION" -gt "$VERSION_CODE_SAFETY_LIMIT" ]; then
            echo "::error::versionCode $VERSION exceeds safety limit of $VERSION_CODE_SAFETY_LIMIT."
            echo "::error::"
            echo "::error::This limit exists to prevent accidentally exhausting version codes."
            echo "::error::To increase the limit, edit VERSION_CODE_SAFETY_LIMIT in .github/workflows/publish-android.yml"
            echo "::error::"
            echo "::error::WARNING: Google Play has a hard limit of 2,100,000,000. Once you reach it,"
            echo "::error::you cannot upload new versions of your app."
            exit 1
          fi

          echo "version_code=$VERSION" >> $GITHUB_OUTPUT
          echo "Validated: versionCode=$VERSION (limit: $VERSION_CODE_SAFETY_LIMIT)"

      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-java-gradle

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > ${{ github.workspace }}/release.keystore

      - name: Build Release Bundle
        run: |
          ./gradlew :compose-app:bundleRelease --stacktrace \
            -PVERSION_CODE=${{ steps.validate.outputs.version_code }} \
            -PKEYSTORE_PATH=${{ github.workspace }}/release.keystore \
            -PKEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
            -PKEY_ALIAS=${{ secrets.KEY_ALIAS }} \
            -PKEY_PASSWORD=${{ secrets.KEY_PASSWORD }}

      - name: Upload Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: compose-app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Publish to Play Store (Internal Track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.chriscartland.batterybutler
          releaseFiles: compose-app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution/whatsnew

      - name: Cleanup Keystore
        if: always()
        run: rm -f ${{ github.workspace }}/release.keystore
