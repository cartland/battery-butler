# =============================================================================
# UPDATE SCREENSHOTS WORKFLOW
# =============================================================================
#
# PURPOSE:
#   Automatically generate and commit Android screenshot test baselines when
#   UI code changes.
#
# BEHAVIOR:
#   - On Pull Requests: Commits screenshot updates directly to the PR branch
#   - On Main Push: Creates a follow-up PR with updates (fallback)
#
# SETUP REQUIRED:
#   To enable auto-commits to PR branches, you need to create a Personal Access
#   Token (PAT) and add it as a repository secret.
#
#   Step 1: Create a Fine-Grained Personal Access Token
#     1. Go to https://github.com/settings/tokens?type=beta
#     2. Click "Generate new token"
#     3. Name: "Battery Butler Bot" (or similar)
#     4. Expiration: Choose based on your security policy (90 days recommended)
#     5. Repository access: Select "Only select repositories" → this repo
#     6. Permissions:
#        - Contents: Read and write
#        - Pull requests: Read and write
#        - Metadata: Read (auto-selected)
#     7. Click "Generate token" and copy the token
#
#   Step 2: Add the token as a repository secret
#     1. Go to repository Settings → Secrets and variables → Actions
#     2. Click "New repository secret"
#     3. Name: BOT_PAT
#     4. Value: Paste the token from Step 1
#     5. Click "Add secret"
#
#   Step 3: Test
#     Create a PR with UI changes and verify screenshots are auto-updated.
#
# TROUBLESHOOTING:
#   - "Resource not accessible by integration": PAT doesn't have correct permissions
#   - "Bad credentials": PAT has expired, create a new one
#   - Screenshots not updating on PRs: Check that BOT_PAT secret exists
#
# =============================================================================

name: Update Screenshots

on:
  # Run on pull requests to update screenshots before merge
  pull_request:
    branches: [main]
    paths:
      - 'compose-app/**'
      - 'presentation-*/**'
      - 'android-screenshot-tests/**'

  # Also run on main push as fallback (creates follow-up PR)
  push:
    branches: [main]
    paths:
      - 'compose-app/**'
      - 'presentation-*/**'
      - 'android-screenshot-tests/**'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  update-screenshots:
    # Skip if this is a commit from the bot itself (prevent loops)
    if: github.actor != 'github-actions[bot]'

    # Ubuntu is faster and cheaper - screenshot tests use Paparazzi (no emulator needed)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # =========================================================================
      # STEP 1: Check if BOT_PAT is configured
      # =========================================================================
      - name: Check PAT Configuration
        id: check-pat
        run: |
          if [ -z "${{ secrets.BOT_PAT }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::BOT_PAT secret is not configured."
            echo "::warning::"
            echo "::warning::Without BOT_PAT, screenshot updates cannot be committed to PR branches."
            echo "::warning::Updates will be created as separate PRs instead."
            echo "::warning::"
            echo "::warning::To enable auto-commits to PRs, follow the setup instructions"
            echo "::warning::in .github/workflows/update-screenshots.yml"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "✓ BOT_PAT is configured"
          fi

      # =========================================================================
      # STEP 2: Checkout code
      # =========================================================================
      # For PRs with BOT_PAT: checkout the PR branch with push access
      - name: Checkout (PR with PAT)
        if: github.event_name == 'pull_request' && steps.check-pat.outputs.configured == 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.BOT_PAT }}
          fetch-depth: 0

      # For PRs without PAT or main push: regular checkout
      - name: Checkout (Standard)
        if: github.event_name != 'pull_request' || steps.check-pat.outputs.configured != 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # =========================================================================
      # STEP 3: Setup build environment
      # =========================================================================
      - uses: ./.github/actions/setup-java-gradle

      # =========================================================================
      # STEP 4: Clean up old screenshots and generate new ones
      # =========================================================================
      # Remove old baseline images before regenerating to prevent orphaned files
      # when tests are renamed or deleted. The updateDebugScreenshotTest task will
      # recreate all current baselines.
      - name: Clean Old Screenshots
        run: |
          SCREENSHOT_DIR="android-screenshot-tests/src/screenshotTestDebug/reference"
          if [ -d "$SCREENSHOT_DIR" ]; then
            echo "Removing old screenshot baselines..."
            rm -rf "$SCREENSHOT_DIR"
            echo "Old baselines removed."
          fi

      - name: Generate Screenshots
        run: ./gradlew :android-screenshot-tests:updateDebugScreenshotTest

      # =========================================================================
      # STEP 5: Validate generated output
      # =========================================================================
      # This step fails the build if generation produced nothing or is obviously broken.
      # Without this check, a broken generator could silently "succeed" with empty output.
      - name: Validate Generated Files
        run: |
          echo "Validating that screenshot generation produced valid output..."
          ./scripts/validate-generated.sh --screenshots

      # =========================================================================
      # STEP 6: Commit changes
      # =========================================================================
      # For PRs with BOT_PAT: commit directly to PR branch
      - name: Commit to PR Branch
        if: github.event_name == 'pull_request' && steps.check-pat.outputs.configured == 'true'
        id: commit-to-pr
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check for changes
          git add -A
          if git diff --staged --quiet; then
            echo "No screenshot changes detected"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "Committing screenshot updates..."
            git commit -m "test: Auto-update Android screenshots

          Generated by Update Screenshots workflow.
          [skip ci]"

            # Push changes
            if git push; then
              echo "✓ Screenshot updates committed to PR branch"
              echo "changes=true" >> $GITHUB_OUTPUT
            else
              echo "::error::Failed to push screenshot updates."
              echo "::error::"
              echo "::error::Possible causes:"
              echo "::error::  1. BOT_PAT has expired - create a new token"
              echo "::error::  2. BOT_PAT lacks write permissions - check token settings"
              echo "::error::  3. Branch protection rules - ensure bot can push"
              echo "::error::"
              echo "::error::See .github/workflows/update-screenshots.yml for setup instructions."
              exit 1
            fi
          fi

      # =========================================================================
      # STEP 7: Close stale auto-update PRs before creating new one
      # =========================================================================
      # This prevents accumulation of outdated PRs that can have merge conflicts
      - name: Close Stale Auto-Update PRs
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && steps.check-pat.outputs.configured != 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing auto/update-screenshots PRs..."

          # Find and close any existing PRs from the auto/update-screenshots branch
          EXISTING_PRS=$(gh pr list --head "auto/update-screenshots" --state open --json number,title --jq '.[].number')

          if [ -n "$EXISTING_PRS" ]; then
            for PR_NUM in $EXISTING_PRS; do
              echo "Closing stale PR #$PR_NUM..."
              gh pr close "$PR_NUM" --comment "Closing: Superseded by newer auto-generated screenshots from the latest main branch commit."
            done
            echo "✓ Closed stale PRs"
          else
            echo "No existing auto-update PRs to close"
          fi

          # Delete the old branch if it exists (ensures fresh start)
          if git ls-remote --heads origin auto/update-screenshots | grep -q auto/update-screenshots; then
            echo "Deleting old auto/update-screenshots branch..."
            git push origin --delete auto/update-screenshots || true
            echo "✓ Old branch deleted"
          fi

      # For main push or if PAT not configured: create follow-up PR
      # NOTE: Using BOT_PAT (if available) is required to trigger CI on the created PR.
      # When using GITHUB_TOKEN, GitHub Actions prevents triggering workflows to avoid loops.
      - name: Create Pull Request (Fallback)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && steps.check-pat.outputs.configured != 'true')
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.check-pat.outputs.configured == 'true' && secrets.BOT_PAT || secrets.GITHUB_TOKEN }}
          commit-message: "test: Auto-update Android screenshots"
          title: "test: Auto-update Android screenshots"
          body: |
            Auto-generated screenshot updates from CI.

            This PR was automatically created by the Update Screenshots workflow.

            **Commit:** ${{ github.sha }}
            **Triggered by:** Push to main

            ---
            ${{ steps.check-pat.outputs.configured != 'true' && '⚠️ **Note:** CI checks may not run automatically on this PR because `BOT_PAT` is not configured. To enable CI triggering, configure the `BOT_PAT` secret. See `.github/workflows/update-screenshots.yml` for setup instructions.' || '' }}
          branch: auto/update-screenshots
          base: main
          delete-branch: true
          labels: automated
